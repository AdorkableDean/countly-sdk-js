Countly = {};
Countly.serverUrl = "";
Countly.appKey = "";
Countly.ready = false;
Countly.CountlyMessagingMode = {"TEST":0,"PRODUCTION":1};
// countly initialization
<<<<<<< HEAD
Countly.init = function(serverUrl,appKey){
    Countly.serverUrl = serverUrl;
    Countly.appKey = appKey;
    cordova.exec(Countly.onSuccess,Countly.onError,"CountlyCordova","init",[serverUrl,appKey]);
}

Countly.initMessaging = function(options){
    alert(JSON.stringify(options))
    Countly.projectId = options.projectId;
    Countly.messageMode = options.messageMode;
    Countly.Push.onRegisterPushNotification();
}

// countly sending various types of events
Countly.sendEvent = function(options){
=======
CountlyCordova.init = function(serverUrl,appKey){
    CountlyCordova.serverUrl = serverUrl;
    CountlyCordova.appKey = appKey;
    cordova.exec(CountlyCordova.onSuccess,CountlyCordova.onError,"CountlyCordova","init",[serverUrl,appKey]);
}

// countly sending various types of events
CountlyCordova.sendEvent = function(options){
>>>>>>> 5b7e7fd017033ddcb3a7ce478c06124a4332e4dc
    var args = [];
    var eventType = "event"; //event, eventWithSum, eventWithSegment, eventWithSumSegment
    var segments = {};
    
    if(options.eventSum)
        eventType = "eventWithSum";
    if(options.segments)
        eventType = "eventWithSegment";
    if(options.segments && options.eventSum)
        eventType = "eventWithSumSegment";
<<<<<<< HEAD

    args.push(eventType);

=======
    
    args.push(eventType);
    
>>>>>>> 5b7e7fd017033ddcb3a7ce478c06124a4332e4dc
    if(options.eventName)
        args.push(options.eventName.toString());
    if(options.eventCount)
        args.push(options.eventCount.toString());
    if(options.eventSum)
        args.push(options.eventSum.toString());
<<<<<<< HEAD

=======
    
>>>>>>> 5b7e7fd017033ddcb3a7ce478c06124a4332e4dc
    if(options.segments)
        segments = options.segments;
    for (var event in segments) {
        args.push(event);
        args.push(segments[event]);
    }
<<<<<<< HEAD
    cordova.exec(Countly.onSuccess,Countly.onError,"CountlyCordova","event",args);
}

// countly enable logger
Countly.setLoggingEnabled = function(boolean){
    cordova.exec(Countly.onSuccess,Countly.onError,"CountlyCordova","setloggingenabled",[]);
}

// countly sending user data
Countly.setUserData = function(options){
=======
    cordova.exec(CountlyCordova.onSuccess,CountlyCordova.onError,"CountlyCordova","event",args);
}

// countly enable logger
CountlyCordova.setLoggingEnabled = function(boolean){
    cordova.exec(CountlyCordova.onSuccess,CountlyCordova.onError,"CountlyCordova","setloggingenabled",[]);
}

// countly sending user data
CountlyCordova.setUserData = function(options){
>>>>>>> 5b7e7fd017033ddcb3a7ce478c06124a4332e4dc
    var args = [];
    args.push(options.name || "");
    args.push(options.username || "");
    args.push(options.email || "");
    args.push(options.org || "");
    args.push(options.phone || "");
    args.push(options.picture || "");
    args.push(options.picturePath || "");
    args.push(options.gender || "");
<<<<<<< HEAD
    args.push(options.byear || 0);

    cordova.exec(Countly.onSuccess,Countly.onError,"CountlyCordova","setuserdata",args);
}

Countly.onRegistrationId = function(options){
    var args = [];
    args.push(options.registrationId || "");
    args.push(options.mode || 0);

    cordova.exec(Countly.onSuccess,Countly.onError,"CountlyCordova","onregistrationid",args);
}
// countly start for android
Countly.start = function(){
    cordova.exec(Countly.onSuccess,Countly.onError,"CountlyCordova","start",[]);
}

// countly stop for android
Countly.stop = function(){
    cordova.exec(Countly.onSuccess,Countly.onError,"CountlyCordova","stop",[]);
}

// countly deviceready for testing purpose
Countly.deviceready = function(){
    Countly.ready = true;
=======
    args.push(options.byear.toString() || "0");
    
    cordova.exec(CountlyCordova.onSuccess,CountlyCordova.onError,"CountlyCordova","setuserdata",args);
}

CountlyCordova.onRegistrationId = function(options){
    var args = [];
    args.push(options.registrationId || "");
    args.push(options.mode.toString() || "0");
    
    cordova.exec(CountlyCordova.onSuccess,CountlyCordova.onError,"CountlyCordova","onregistrationid",args);
}
// countly start for android
CountlyCordova.start = function(){
    cordova.exec(CountlyCordova.onSuccess,CountlyCordova.onError,"CountlyCordova","start",[]);
}

// countly stop for android
CountlyCordova.stop = function(){
    cordova.exec(CountlyCordova.onSuccess,CountlyCordova.onError,"CountlyCordova","stop",[]);
}

// countly deviceready for testing purpose
CountlyCordova.deviceready = function(){
    CountlyCordova.ready = true;
>>>>>>> 5b7e7fd017033ddcb3a7ce478c06124a4332e4dc
    //testing
}

// countly dummy success and error event
<<<<<<< HEAD
Countly.onSuccess = function(result){
    //alert(result);
}
Countly.onError = function(error){
    // alert("error");
    // alert(error);
}
Countly.demo = function(){
=======
CountlyCordova.onSuccess = function(result){
    //alert(result);
}
CountlyCordova.onError = function(error){
    // alert("error");
    // alert(error);
}
CountlyCordova.demo = function(){
>>>>>>> 5b7e7fd017033ddcb3a7ce478c06124a4332e4dc
    
}

/////////////////////////
////// PUSH CODE ////////
/////////////////////////

var push = {};
Countly.Push = push;
push.onRegisterPushNotification = function(){
    var pushNotification = window.plugins.pushNotification;
    if(!window.device){
        console.error("dependency required org.apache.cordova.device to know android or ios device.");
        return;
    }
    if (device.platform == 'android' || device.platform == 'Android') {
        pushNotification.register(push.onPushSucess, push.onPushError,{"senderID":Countly.projectId,"ecb":"Countly.Push.onNotificationGCM"});
    }
    else{
        pushNotification.register(push.onPushSucess,push.onPushError,{"badge":"true","sound":"true","alert":"true","ecb":"Countly.Push.onNotificationAPN"});
    }
}
push.onPushSucess = function(result){
    push.onPushId(result)
}
push.onPushError = function(error){
<<<<<<< HEAD
    alert(error)
=======
    console.log("push failed : "error);
>>>>>>> 5b7e7fd017033ddcb3a7ce478c06124a4332e4dc
}
push.onPushId = function(pushId){
    if(pushId == "OK" || pushId == "ok")
        return
        push.pushId = pushId;
    push.onSendPushId();
}

push.onSendPushId = function(){
<<<<<<< HEAD
    alert(push.pushId)
    var options = {"registrationId":push.pushId,"mode":Countly.CountlyMessagingMode.TEST};
    Countly.onRegistrationId(options);
=======
    var pushDevice = null;
    if (device.platform == 'android' || device.platform == 'Android') {
        pushDevice = "android";
    }
    else{
        pushDevice = "ios";
    }
    
    console.log(push.pushId +" push.pushId");
    if(push.pushId && Meteor.user()){
        //if(!Meteor.user().profile.pushId){
        var options = {"pushId":push.pushId,"pushDevice":pushDevice};
        Meteor.call("getPushId",options,function(){});
        //}
        
    }
    else{
        if(Meteor.user())
            push.onRegisterPushNotification();
    }
>>>>>>> 5b7e7fd017033ddcb3a7ce478c06124a4332e4dc
}
push.onSendPushIdCallback = function(err,success){
    if(err){
        push.onSendPushId();
    }
}
push.onNotificationGCM = function(e){
    alert(e.event)
    switch( e.event )
    {
        case 'registered':
            if ( e.regid.length > 0 ){
                console.log("Regid " + e.regid);
                push.onPushId(e.regid);
            }
            break;
            
        case 'message':
            
            break;
            
        case 'error':
            
            break;
            
        default:
            console.log('An unknown GCM event has occurred');
            break;
    }
}
push.onNotificationAPN = function(event){
    var pushNotification = window.plugins.pushNotification;
    if (event.alert) {
        navigator.notification.alert(event.alert);
    }
    if (event.badge) {
        pushNotification.setApplicationIconBadgeNumber(push.onPushSucess, push.onPushError, event.badge);
    }
    if (event.sound) {
        var snd = new Media(event.sound);
        snd.play();
    }
}

/////////////////////////
////// PUSH CODE ////////
/////////////////////////

window.Countly = Countly;
document.addEventListener("deviceready", Countly.deviceready, false);